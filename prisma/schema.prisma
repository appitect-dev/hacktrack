generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ────────────────────────────────────────────────────────────────────

enum InputType {
  COUNTER
  NUMBER
}

enum Role {
  SUPERADMIN
  ORGANIZER
  MEMBER
}

enum HackathonStatus {
  DRAFT
  ACTIVE
  ENDED
}

enum ProposalStatus {
  PENDING
  APPROVED
  REJECTED
}

// ─── User ─────────────────────────────────────────────────────────────────────

model User {
  id        String   @id @default(cuid())
  name      String   @unique
  pinHash   String
  color     String   @default("#00ff41")
  role      Role     @default(MEMBER)
  createdAt DateTime @default(now())

  metrics             Metric[]
  memberships         TeamMembership[]
  proposals           MetricProposal[]
  createdDefinitions  MetricDefinition[]
  organizedHackathons Hackathon[]
}

// ─── Hackathon ─────────────────────────────────────────────────────────────────

model Hackathon {
  id          String          @id @default(cuid())
  name        String
  description String?
  status      HackathonStatus @default(DRAFT)
  startAt     DateTime
  endAt       DateTime
  organizerId String
  createdAt   DateTime        @default(now())

  organizer   User               @relation(fields: [organizerId], references: [id])
  teams       Team[]
  definitions MetricDefinition[]
  proposals   MetricProposal[]
}

// ─── Team ──────────────────────────────────────────────────────────────────────

model Team {
  id          String   @id @default(cuid())
  name        String
  color       String   @default("#00ff41")
  inviteCode  String   @unique
  hackathonId String
  createdAt   DateTime @default(now())

  hackathon Hackathon        @relation(fields: [hackathonId], references: [id])
  members   TeamMembership[]
  metrics   Metric[]
}

// ─── TeamMembership ────────────────────────────────────────────────────────────

model TeamMembership {
  id       String   @id @default(cuid())
  userId   String
  teamId   String
  isAdmin  Boolean  @default(false)
  joinedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  team Team @relation(fields: [teamId], references: [id])

  @@unique([userId, teamId])
  @@index([teamId])
}

// ─── MetricDefinition ─────────────────────────────────────────────────────────

model MetricDefinition {
  id          String    @id @default(cuid())
  slug        String
  name        String
  icon        String    @default("///")
  color       String    @default("#00ff41")
  inputType   InputType @default(COUNTER)
  unit        String    @default("")
  isDefault   Boolean   @default(false)
  hackathonId String    // scoped to hackathon; seed creates per-hackathon definitions
  createdBy   String?
  createdAt   DateTime  @default(now())

  hackathon Hackathon        @relation(fields: [hackathonId], references: [id])
  creator   User?            @relation(fields: [createdBy], references: [id])
  proposals MetricProposal[]

  @@unique([slug, hackathonId])
}

// ─── Metric ───────────────────────────────────────────────────────────────────

model Metric {
  id        String   @id @default(cuid())
  userId    String
  teamId    String?  // null = legacy (pre-team)
  type      String   // slug reference to MetricDefinition
  value     Float
  createdAt DateTime @default(now())

  user User  @relation(fields: [userId], references: [id])
  team Team? @relation(fields: [teamId], references: [id])

  @@index([userId])
  @@index([teamId])
  @@index([userId, type])
  @@index([teamId, type])
}

// ─── MetricProposal ───────────────────────────────────────────────────────────

model MetricProposal {
  id           String         @id @default(cuid())
  name         String
  slug         String
  icon         String         @default("///")
  inputType    InputType      @default(COUNTER)
  unit         String         @default("")
  status       ProposalStatus @default(PENDING)
  reason       String?        // rejection reason from organizer
  proposedById String
  hackathonId  String
  definitionId String?        // set when approved → links to created definition
  createdAt    DateTime       @default(now())
  resolvedAt   DateTime?

  proposedBy User              @relation(fields: [proposedById], references: [id])
  hackathon  Hackathon         @relation(fields: [hackathonId], references: [id])
  definition MetricDefinition? @relation(fields: [definitionId], references: [id])

  @@index([hackathonId, status])
}
